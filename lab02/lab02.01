const int YELLOW = 4;
const int RED = 3;
const int GREEN = 2;

const int TEMP_SENSOR = A0;
const int LIGHT_SENSOR = A1;
const int POT_SENSOR = A3;

int tempValue = 0;     // temperature sensor value
int tempMin = 1023;    // minimum temperature sensor value
int tempMax = 0;       // maximum temperature sensor value

int lightValue = 0;    // light sensor value
int lightMin = 1023;   // minimum light sensor value
int lightMax = 0;      // maximum light sensor value

int potValue = 0;      // potentiometer value
int potMin = 1023;     // minimum potentiometer value
int potMax = 0;        // maximum potentiometer value

const int TEMP_THRESHOLD = 26;           // degrees celsius
const unsigned long MIN_PERIOD = 200;    // 0.2 seconds
const unsigned long MAX_PERIOD = 2000;   // 2 seconds

unsigned long period;




void setup() {
  pinMode(RED, OUTPUT);
  pinMode(GREEN, OUTPUT);
  pinMode(YELLOW, OUTPUT);
  
  Serial.begin(9600); // debug purposes
  
  Serial.println("Calibration started");
  
  /*
   * Calibration techine:
   * The board takes sensor readings for five seconds during the startup, and
   * tracks the highest and lowest values it gets. These sensor readings during
   * the first five seconds of the sketch execution define the minimum and maximum
   * of expected values for the readings taken during the loop.
  */
  
  // calibrate during the first five seconds
  while (millis() < 5000) {
    tempValue = analogRead(TEMP_SENSOR);
    lightValue = analogRead(LIGHT_SENSOR);
    potValue = analogRead(POT_SENSOR);

    // record the minimum and maximum temperature sensor value
    if (tempValue > tempMax) { tempMax = tempValue; }
    if (tempValue < tempMin) { tempMin = tempValue; }
    
    // record the minimum and maximum light sensor value
    if (lightValue > lightMax) { lightMax = lightValue; }
    if (lightValue < lightMin) { lightMin = lightValue; }
    
    // record the minimum and maximum potentiometer value
    if (potValue > potMax) { potMax = potValue; }
    if (potValue < potMin) { potMin = potValue; }
  }
  Serial.println("Calibration done");


}

void loop() {
 
 controlTemperature();
 
 controlRotationAngle();

 controlLightItensity();

}




void controlTemperature(){
  float temp;

  // read the sensors
  tempValue = analogRead(TEMP_SENSOR);
 
  // apply the calibration to the sensors reading
  tempValue = map(tempValue, tempMin, tempMax, 0, 1024);
 
  // in case the sensor value is outside the range seen during calibration
  tempValue = constrain(tempValue, 0, 1024);  
  temp = T(tempValue);
  
  Serial.print("\nTemperature:    "); Serial.print(temp); Serial.println(" ยบC");
    
  if (temp > TEMP_THRESHOLD) {
    digitalWrite(YELLOW, HIGH);
  } else {
    digitalWrite(YELLOW, LOW);
  }
  
}


void controlLightItensity(){

  static unsigned long delayBlink ; 
  lightValue = analogRead(LIGHT_SENSOR);
  lightValue = map(lightValue, lightMin, lightMax, 0, 255);
  lightValue = constrain(lightValue, 0, 255);
  Serial.print("Light intensity: "); Serial.print(lightValue); Serial.println(" light intensity");

  /*
  //lightValue defines the intensity of the ligth 
  if(lightValue == 0  && (millis() - delayBlink) < 200 )
  {
    // fade the LED using the calibrated value:
    analogWrite(RED, lightValue);
  }
  else if(lightValue > 0 && lightValue < 64)
  {
    // fade the LED using the calibrated value:
    analogWrite(RED, lightValue);
  }
  else if(lightValue > 64 && lightValue < 127)
  {
    
  }
  else if(lightValue > 127 && lightValue < 191)
  {
    
  }
  else if(lightValue > 191 && lightValue =< 255)
  {
    
  }
  */
  //lightValue defines the intensity of the ligth (https://www.arduino.cc/en/Tutorial/PWM) 
  if((millis() - delayBlink) == 200 )
  {
    
    delayBlink = millis();
    analogWrite(RED, lightValue);
  }
 
}


void controlRotationAngle(){

  static unsigned long delayBlink;  
  float deg;

  potValue = analogRead(POT_SENSOR);
  deg = map(potValue, potMin, potMax, 0, 180);

  deg = constrain(deg, 0, 180);
  Serial.print("Degrees:         "); Serial.print(deg); Serial.println(" ยบ");

  period = P(deg);
  

   if ( (millis() - delayBlink) < period ) {
      digitalWrite(GREEN, HIGH);
  } else {
      digitalWrite(GREEN, LOW);
      delayBlink = millis();
  }

}

float T(int value) {
  
  // getting the voltage from the value read from the sensor
  float voltage = value / 1024.0 * 5.0;
  
  // converting from 10 mv per degree with 500 mV offset
  float temperature = (voltage - 0.5) * 100;

  return temperature; 
}

float P(int value) {
   return 0.01 * value - 0.2; 
}
